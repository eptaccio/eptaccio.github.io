{"componentChunkName":"component---src-templates-blog-post-js","path":"/dj-marcinho/","result":{"data":{"site":{"siteMetadata":{"title":"eptaccio"}},"markdownRemark":{"id":"baaea9e2-486e-55a6-9428-7b3a346ba25e","excerpt":"Esse bot é uma continução do meu primeiro post onde mostro como criar um BOT e subir no now.sh. Primeiramente peço perdão a todos DJs, produtores e pessoas que…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6bdc2fa5d9194a6227bb45ff985d48a0/3382b/bg.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAavHKKbA/8QAGRAAAwEBAQAAAAAAAAAAAAAAAQISAAMi/9oACAEBAAEFAgRLqSr1Xf3nc5Uvf//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EAB4QAQABAwUBAAAAAAAAAAAAAAEAAiFBESIxUWGB/9oACAEBAAY/AnfVAGx5OaY4TPcNcRbfSf/EAB4QAQACAgEFAAAAAAAAAAAAAAEAETFBIWGBkaGx/9oACAEBAAE/IRmEbaPCalHjQ3PU3l7wBR0z6mZPPTVzIMqyM//aAAwDAQACAAMAAAAQEw//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAdEAEBAAICAwEAAAAAAAAAAAABEQAhMUFRYfCB/9oACAEBAAE/EBA+6olmheQRw+IeAnz1gvfAKg1+4I3emxog79eMYNE9fBx3cXYAlaUHaJ58Z//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"mesa de audio\"\n        title=\"mesa de audio\"\n        src=\"/static/6bdc2fa5d9194a6227bb45ff985d48a0/1c72d/bg.jpg\"\n        srcset=\"/static/6bdc2fa5d9194a6227bb45ff985d48a0/a80bd/bg.jpg 148w,\n/static/6bdc2fa5d9194a6227bb45ff985d48a0/1c91a/bg.jpg 295w,\n/static/6bdc2fa5d9194a6227bb45ff985d48a0/1c72d/bg.jpg 590w,\n/static/6bdc2fa5d9194a6227bb45ff985d48a0/a8a14/bg.jpg 885w,\n/static/6bdc2fa5d9194a6227bb45ff985d48a0/fbd2c/bg.jpg 1180w,\n/static/6bdc2fa5d9194a6227bb45ff985d48a0/3382b/bg.jpg 3822w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Esse bot é uma continução do meu <a href=\"/telegram-bot/\">primeiro post</a> onde mostro como criar um BOT e subir no <a href=\"now.sh\">now.sh</a>.</p>\n<p>Primeiramente peço perdão a todos DJs, produtores e pessoas que realmente mixam coisas. Isso que vou mostrar é uma brincadeira de final de semana onde tava entediado.</p>\n<p>Eu sempre gostei muito de música, mas infelizmente nunca aprendi tocar nada. E por não saber nada de música também, nunca consegui trabalhar em produções. Esse experimento é uma forma de eu conseguir demonstrar meu amor por música.</p>\n<p>Antes que você desista do texto, porque já escrevi demais, esse é resultado final:</p>\n<p><div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 75%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem\" > <div><iframe src=\"https://www.youtube.com/embed/f-t-iY14bSM\" style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe></div> </div>\n<a href=\"https://t.me/DjMarcinhoBot\"><em>Converse com o DJ Marcinho no telegram</em></a></p>\n<hr>\n<h2>Ingredientes</h2>\n<h3>ffmpeg</h3>\n<p>Mixagem de áudio programaticamente é uma coisa muito interessante: para esse bot utilizei o <a href=\"https://www.ffmpeg.org/\">ffmpeg</a>. Uma solução de linha de comando open source para manipulação de áudio.</p>\n<h3>now.sh</h3>\n<p>Uma plataforma para funções serverless que tem limites gratuitos bem generosos para códigos <strong>OPEN SOURCE</strong>.</p>\n<h3>node.js</h3>\n<p>Ah mano, uma plataforma que usa o V8 da google para tu conseguir criar servidores que rodam javascript.</p>\n<hr>\n<h2>Fluxo</h2>\n<h3><strong>I</strong> - Bot aguarda evento de áudio enviado</h3>\n<p>Pra brincadeira ficar mais legal, eu geralmente adiciono esse bot em grupos do Telegram. Como já mencionado, estou utilizando o <a href=\"https://github.com/telegraf/telegraf\">telegraf</a> que felizmente consegue fazer a filtragem de mensagens programaticamente e separar isso em eventos para facilitar nossa vida.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">bot<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'voice'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'audio'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">ctx</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n <span class=\"token comment\">// lógicas aqui pipipi popopo</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>No final acabei inventando umas modas aqui, mas o conceito base é esse.</p>\n<h3><strong>II</strong> - Envia menu com opções de áudio</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/419fb74749937e5310476c687f9403b3/a0a88/menu.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAwABBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAeYaiNZH/8QAGRAAAwADAAAAAAAAAAAAAAAAAAECERIh/9oACAEBAAEFAmbMmmMwSuf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAEBAQAAAAAAAAAAAAAAAAABEDH/2gAIAQEABj8C1rf/xAAbEAEAAgIDAAAAAAAAAAAAAAABABExoRCRsf/aAAgBAQABPyEtrugZmUsvc9uG5P/aAAwDAQACAAMAAAAQyy//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPxCn/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRAAAgEEAwAAAAAAAAAAAAAAAAFRESExYXGRof/aAAgBAQABPxCWtvKRIVbpLY69c0hLpsc/C4v00f/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"menu do bot quando um áudio chega\"\n        title=\"menu do bot quando um áudio chega\"\n        src=\"/static/419fb74749937e5310476c687f9403b3/1c72d/menu.jpg\"\n        srcset=\"/static/419fb74749937e5310476c687f9403b3/a80bd/menu.jpg 148w,\n/static/419fb74749937e5310476c687f9403b3/1c91a/menu.jpg 295w,\n/static/419fb74749937e5310476c687f9403b3/1c72d/menu.jpg 590w,\n/static/419fb74749937e5310476c687f9403b3/a8a14/menu.jpg 885w,\n/static/419fb74749937e5310476c687f9403b3/fbd2c/menu.jpg 1180w,\n/static/419fb74749937e5310476c687f9403b3/a0a88/menu.jpg 1647w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>O projeto tem uma pasta com os áudios na raiz, o bot faz uma lista com o nome dos arquivos utilizando o módulo <strong>fs</strong>. Isso serve para oferecer no menu posteriormente:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// avaibleBeats.js</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> getBeatsPath <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'lib/path'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> avaibleBeats <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readdirSync</span><span class=\"token punctuation\">(</span><span class=\"token function\">getBeatsPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  avaibleBeats\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>À partir dessa listagem dos áudios disponíveis, montei uma lista de “callback button” (botão de retorno). O telegraf também abstrai isso de um jeito bem fácil.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"> <span class=\"token keyword\">const</span> callBacks <span class=\"token operator\">=</span> avaibleBeats<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">beat</span> <span class=\"token operator\">=></span>\n    <span class=\"token punctuation\">[</span>Markup<span class=\"token punctuation\">.</span><span class=\"token function\">callbackButton</span><span class=\"token punctuation\">(</span>beat<span class=\"token punctuation\">,</span> beat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> inlineMessageRatingKeyboard <span class=\"token operator\">=</span> Markup\n    <span class=\"token punctuation\">.</span><span class=\"token function\">inlineKeyboard</span><span class=\"token punctuation\">(</span>callBacks<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">extra</span><span class=\"token punctuation\">(</span>\n      <span class=\"token comment\">// opção para responder diretamente no aúdio</span>\n      Extra<span class=\"token punctuation\">.</span><span class=\"token function\">inReplyTo</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>message_id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">reply</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'Select a style'</span><span class=\"token punctuation\">,</span>\n    inlineMessageRatingKeyboard\n  <span class=\"token punctuation\">)</span></code></pre></div>\n<h3><strong>III</strong> - Faz download do áudio enviado</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">saveFileLocal</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> filePath<span class=\"token punctuation\">,</span> bot<span class=\"token punctuation\">,</span> fileId <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> fileLink <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> bot<span class=\"token punctuation\">.</span>telegram<span class=\"token punctuation\">.</span><span class=\"token function\">getFileLink</span><span class=\"token punctuation\">(</span>fileId<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> fileStream <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    url<span class=\"token operator\">:</span> fileLink<span class=\"token punctuation\">,</span>\n    responseType<span class=\"token operator\">:</span> <span class=\"token string\">'stream'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> writeFileStream <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">createWriteStream</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    writeFileStream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'finish'</span><span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">)</span>\n    writeFileStream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n\n    fileStream\n      <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>writeFileStream<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Explicando em detalhes:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> fileLink <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> bot<span class=\"token punctuation\">.</span>telegram<span class=\"token punctuation\">.</span><span class=\"token function\">getFileLink</span><span class=\"token punctuation\">(</span>fileId<span class=\"token punctuation\">)</span></code></pre></div>\n<p>A linha de código acima constrói o link para download do arquivo de áudio enviado pelo usuário.</p>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> fileStream <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">axios</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  url<span class=\"token operator\">:</span> fileLink<span class=\"token punctuation\">,</span>\n  responseType<span class=\"token operator\">:</span> <span class=\"token string\">'stream'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Aqui estou utilizando streams. Caso não esteja familiarizado, veja esse <a href=\"https://imasters.com.br/back-end/streams-no-node-js-o-que-sao-streams-afinal-parte-01\">post sobre</a>. Estou recebendo um fileStream da API do telegram e juntando isso à um writeFileStream, que é um stream de escrita para escrever o arquivo no disco.</p>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  writeFileStream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'finish'</span><span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">)</span>\n  writeFileStream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n\n  fileStream\n    <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>writeFileStream<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Como estou retornando uma promise, passei o <strong>resolve</strong> e <strong>reject</strong> da promise para os eventos de <strong>finish</strong> e <strong>error</strong>.</p>\n<p>Esse bot está rodando em serverless no <a href=\"now.sh\">now.sh</a>. No geral não é possivel escrever no disco de uma função serverless (perdi um tempinho para descobrir isso na primeira vez). Então todos os áudios são salvos na pasta <strong>TEMP</strong> do <strong>SO</strong>. <em>Grazadeus</em> no modulo os do node temos uma função chamada tmpdir que nos passa o caminho da pasta TEMP do SO em questão. Assim fica mais fácil!</p>\n<p>Aqui acabamos entrando em um tópico de privacidade: todos os áudios são <strong>TEMPORÁRIOS</strong>, nada fica salvo em nenhuma base de dados.</p>\n<h3><strong>IV</strong> - Aciona o ffmpeg para fazer o mix do aúdio do usário com a faixa selecionada</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> stdout<span class=\"token punctuation\">,</span> stderr <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">spawn</span><span class=\"token punctuation\">(</span>binariePatch<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'close'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>outputDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Como comentei no inicio do post, estou utilizando o <strong>ffmpeg</strong>. Isso mesmo! Eu subi o binário juntamente ao deploy e estou executando o mesmo usando o metodo <strong>spawn</strong> do módulo <strong>child_process</strong>.</p>\n<p><strong>child_process</strong> é um modulo nativo no nodejs que permite que a gente crie novos processos à partir do processo principal. Com esse módulo, o nosso bot cria um processo no SO executando um binário (<strong>ffmpeg</strong>) com os argumentos que precisava para fazer o mix do áudio acontecer.</p>\n<p>O módulo <strong>child_process</strong> possui alguns metodos para esse típo de ação, dentre eles: <strong>fork()</strong>, <strong>spawn()</strong>, <strong>exec()</strong> e <strong>execFile()</strong>. Estou utilizando o método <strong>spawn()</strong> lançando um novo comando no SO, recebendo como resposta um objeto do tipo <strong>ChildProcess</strong>, que implementa o <strong>EventEmitter API</strong> para nos permitir adicionar listeners (ouvintes), como fiz no código acima.</p>\n<p>Argumentos de mix do <strong>ffmpeg</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mergeArgs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token string\">'-y'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'-i'</span><span class=\"token punctuation\">,</span>\n  filePath<span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'-i'</span><span class=\"token punctuation\">,</span>\n  beatPath<span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'-filter_complex'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'amerge=inputs=2'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'-ac'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span>\n  outputDirectory\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>Essa é a forma que o bot monta os args para o mix de aúdio, no fim isso vai virar algo assim:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ffmpeg -y -i kaio_do_quebradev.ogg -i NARUTO_SAD_SONG.mp3 -filter_complex <span class=\"token assign-left variable\">amerge</span><span class=\"token operator\">=</span>inputs<span class=\"token operator\">=</span><span class=\"token number\">2</span> -ac <span class=\"token number\">2</span> final.mp3</code></pre></div>\n<p><em>Você pode executar isso no seu terminal se tiver o <a href=\"https://ffmpeg.org/\">binário do <strong>ffmpeg</strong></a>, vai rolar!</em></p>\n<h4><strong>Explicando os argumentos utilizados:</strong></h4>\n<ul>\n<li><code class=\"language-text\">-y</code>:<br>\nConfirmação de que você quer sobrescrever o arquivo de output, caso ele já exista.</li>\n<li><code class=\"language-text\">-i</code>:<br>\nInforma um INPUT, ou seja, um áudio que já existe e será utilizado.</li>\n<li><code class=\"language-text\">-filter_complex</code>:<br>\nQuando precisamos fazer algo mais cabreiro no FFMPEG, usamos essa opção para conseguir chegar no resultado. O filter_complex permite que passemos como argumento para processamento do audio um “filter graph”. Como o nome já diz é bem complexo, então não vou me estender, até porque não sou um especialista no assunto.</li>\n</ul>\n<p>Para utilizar esse argumento, estou sempre informando <strong>amerge=inputs=2</strong> que quer dizer: <strong>Eu quero que você faça o merge de dois streams de áudio em um só.</strong></p>\n<ul>\n<li><code class=\"language-text\">-ac</code>:<br>\nSeta o número de canais de áudio. Nessa parte, a gente já começa entrar em uma ciência de foguete, coisa de quem manja de audio real (salve <a href=\"https://twitter.com/gustv0_\">Gustavo</a>). Então se quiser se aprofundar nessa parte, <a href=\"https://trac.ffmpeg.org/wiki/AudioChannelManipulation\">confira esse link</a></li>\n</ul>\n<h3><strong>V</strong> - Envia o áudio pro usuário</h3>\n<p>E claro, a cereja do bolo: enviar o resultado para o usuário:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token keyword\">await</span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">replyWithAudio</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> source<span class=\"token operator\">:</span> file <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Visão geral (programática) do processo</h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> selectedBeatName <span class=\"token operator\">=</span> info<span class=\"token punctuation\">.</span>actionName\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> fileId<span class=\"token punctuation\">,</span> fileType <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">getFileInfo</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> filePath <span class=\"token operator\">=</span> <span class=\"token function\">getFilePath</span><span class=\"token punctuation\">(</span>fileId<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">await</span> <span class=\"token function\">saveFileLocal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> filePath<span class=\"token punctuation\">,</span> bot<span class=\"token punctuation\">,</span> fileId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> outputMixPath <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">mergeAudios</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  filePath<span class=\"token punctuation\">,</span>\n  fileType<span class=\"token punctuation\">,</span>\n  beat<span class=\"token operator\">:</span> selectedBeatName\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> mixResult <span class=\"token operator\">=</span> <span class=\"token function\">getFileBuffer</span><span class=\"token punctuation\">(</span>outputMixPath<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">await</span> <span class=\"token function\">sendFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> fileType<span class=\"token punctuation\">,</span> file<span class=\"token operator\">:</span> mixResult<span class=\"token punctuation\">,</span> ctx <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Deploy</h2>\n<p>Segui basicamente as instruções do <a href=\"/telegram-bot/\">meu primeiro post</a> com um diferencial: na sessão de builds do now.json, informei que o projeto deveria levar os binários do FFMPEG e também as faixas de áudio disponíveis. Se atente ao includeFiles.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">\"builds\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"use\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"@now/node-server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"config\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token string\">\"includeFiles\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"binaries/**\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"audios/**\"</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Resultado final:</h2>\n<p><a href=\"https://t.me/DjMarcinhoBot\"><em>Converse com o DJ Marcinho no telegram</em></a></p>\n<p><a href=\"https://github.com/eptaccio/dj-telegram-bot\">Código no github</a></p>\n<p><a href=\"https://zeit.co/eptaccio/djproducerbot/fvnyq8bgc/source\">Código rodando em PROD</a></p>\n<p>Se tiver algum feedback ou conseguir construir algo legal à partir disso, por favor me chame no <a href=\"https://twitter.com/eptaccio\">twitter</a> ou <a href=\"https://t.me/eptaccio\">telegram</a>.</p>\n<p><a href=\"https://www.youtube.com/watch?v=RxD67KaAJuo\"><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQH/xAAXAQEAAwAAAAAAAAAAAAAAAAADAQIE/9oADAMBAAIQAxAAAAGFPRpIWw6TNCkVXVEH/8QAHBAAAwACAwEAAAAAAAAAAAAAAAIDBBIBETIz/9oACAEBAAEFAsqjKTrRWMiewvW5z5l9T//EABkRAAIDAQAAAAAAAAAAAAAAAAIQARESMf/aAAgBAwEBPwEKyg5K/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAR/9oACAECAQE/ATaiv//EABsQAAEFAQEAAAAAAAAAAAAAAAEAAhARUUFx/9oACAEBAAY/Ag1vULsjIBxNvZ8j/8QAGxAAAgIDAQAAAAAAAAAAAAAAAREAIRAxQXH/2gAIAQEAAT8h0oRuNq0mwQR32JYUHWCLSnlUAC1P/9oADAMBAAIAAwAAABBDEPz/xAAWEQEBAQAAAAAAAAAAAAAAAAABIDH/2gAIAQMBAT8QDzC//8QAGREAAgMBAAAAAAAAAAAAAAAAAAEQESEx/9oACAECAQE/EKu4XUM//8QAHBAAAwACAwEAAAAAAAAAAAAAAAERIXExQWFR/9oACAEBAAE/EMqnoXnSLuxGy2/PSCM+T0TEvaJhnQypsclIYonV0u6ldkjA/9k=&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"reginaldo\" title=\"reginaldo\" src=\"/static/fbd750c50e5dca0da3814d9758203e45/1c72d/reginaldo.jpg\" srcset=\"/static/fbd750c50e5dca0da3814d9758203e45/a80bd/reginaldo.jpg 148w,\n/static/fbd750c50e5dca0da3814d9758203e45/1c91a/reginaldo.jpg 295w,\n/static/fbd750c50e5dca0da3814d9758203e45/1c72d/reginaldo.jpg 590w,\n/static/fbd750c50e5dca0da3814d9758203e45/c08c5/reginaldo.jpg 640w\" sizes=\"(max-width: 590px) 100vw, 590px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span></a></p>\n<p><a href=\"https://www.youtube.com/watch?v=RxD67KaAJuo\">DJ Reginaldo, dono da foto do BOT.</a></p>\n<p>Obrigado por ler até o final.</p>","frontmatter":{"title":"Como eu construi um BOT para mixagem de aúdios no telegram","date":"April 11, 2020","description":"Criando um bot serverless que mixa áudio no telegram com Node.js e FFMPEG","image":"reginaldo.jpg"}}},"pageContext":{"slug":"/dj-marcinho/","previous":{"fields":{"slug":"/telegram-bot/"},"frontmatter":{"title":"Criando um bot serverless para telegram"}},"next":{"fields":{"slug":"/puppeteer/"},"frontmatter":{"title":"Automatizando o chrome com Node.js para zoar amigos"}}}}}