{"componentChunkName":"component---src-templates-blog-post-js","path":"/telegram-bot/","result":{"data":{"site":{"siteMetadata":{"title":"eptaccio"}},"markdownRemark":{"id":"548ebd29-b896-56e6-a62d-291025bb85a4","excerpt":"Eu gosto muito de criar bots, principalmente no telegram pela facilidade. Na verdade eu sempre fui um grande evangelista do Telegram, quem me conhece sabe disso…","html":"<p>Eu gosto muito de criar bots, principalmente no telegram pela facilidade. Na verdade eu sempre fui um grande evangelista do Telegram, quem me conhece sabe disso. Então nada mais justo do que falar sobre bots nessa plataforma que simplifica muito o processo de criação dos mesmos.</p>\n<p>Tá, basicamente vou mostrar duas coisas:</p>\n<ol>\n<li>Como criar um chatbot (usando node.js)</li>\n<li>Como deixar ele “rodando” de graça usando o now.sh</li>\n</ol>\n<h2>Criando o bot no telegram</h2>\n<p>É bem fácil criar um bot no telegram, é tão facil que o telegram tem um bot que cria bots, no caso o <a href=\"http://t.me/BotFather\">@BotFather</a>. É bem simples, inicie a conversa com o BotFather, execute o comando <strong>/newbot</strong> e siga as instruções. No final ele vai te gerar um token para você continuar com o processo.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 416px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0bb9b70bb305fdd80aead4316a4e5231/b0122/token.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 73.61963190184049%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADBklEQVQ4y01UyU4bQRD1x0RIEAzY421sjz2LZ5/pGdvjBVBuUSSwDd4AQ3KIlENOkRJAiHxbwBxDvuKluu1YOTzVNvWqurp6UoPxDPObT5heXWO6uMFs8RGza8LVDaYXC8K1wOzyRsjJfOWbk73yLXA2ucB4donX1z9ISZKChupBVRxYWgCj7sEi1Oo2qoaLuulBIak7IVQrELpKuuFHwq43XGSKCrb3cnh6ekZKyWiIqgx+yUNcZmDVEC2ZwdFCeM0O3LANlyUI4g6CZhdulIDZLcRBFw5rw2/2ELZ6kGsGnpdLpOpOANY7hp/0BMLuITySLOmLZJ+IvKgDh4g5YUDJfjVAqEbw2z2KJdDtEFKphuXyBamKaiFKDkUXPgV5R5zAX3fkx12RZHN/nAjisNMXxXmc5zphC4WKuu7Q9MVHnIC1+4jX5AEdJe4eiy75cXliSHFB0ia91RdH5QVNL0ZOXnfIh8yTFd2GJKsoVnWqpqFAMk/yH7i/qBgo1RobySHXGyKeLSkrwl1JhqxZyFU15KhtqbwC11c+IleInAilch38+51MEW//R7ZEM1wTyhUDLKQ5uU0EQQLTpBt2mnDIdgm2E8Min+c1UaFvLTdGky6Rj4Aj7hyJE25mWC0YCLUIbi2Ap4ZwCdz29Ujors7QNhN4RoSA/F8+f8XtwyNu7x/x4/4Bdw8/8e37HRTNxi++h5rD0Dp8B5evB+0d45U7VLl7JC6h4cewWYsWmwnZoAvg86wQgVw3UVZt1Gi5Nx1maX802ni+PmWCojv0GhxhVykpS68gTXPby5WxJ5WFPCBfRqAGns/1zR4W6MZUO6DKEXUTQXcZNP60vJVuBrHQTerU8pvidRgUz9HFFdYbwfU8YflChPk3RRgZA1pGF7D3GzDSGpQDFda+AX1Pg0Yo0Jvfpe54J/v5MrZ2JWylJWzv55HOVbBzUKAZPiH14f0Ak9Eco8FE4HwwxXgww2hI8nS2sYfDCU5GY5wMz3FKcng+xeBsihH9rcazK/rjzPH79RV/AUXcUaH8r1dPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Criação do token\"\n        title=\"Criação do token\"\n        src=\"/static/0bb9b70bb305fdd80aead4316a4e5231/b0122/token.png\"\n        srcset=\"/static/0bb9b70bb305fdd80aead4316a4e5231/222b7/token.png 163w,\n/static/0bb9b70bb305fdd80aead4316a4e5231/ff46a/token.png 325w,\n/static/0bb9b70bb305fdd80aead4316a4e5231/b0122/token.png 416w\"\n        sizes=\"(max-width: 416px) 100vw, 416px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Vamos de código</h2>\n<p>Usando node.js vou mostrar uma lib para telegram deveras charmosa chamada Telegraf. A API oficial do telegram possui várias rotas e permite várias coisas, essa lib basicamente encapsula esses métodos para facilitar nossa vida.</p>\n<p>A plataforma do telegram tem suporte a webhooks. É aí que entra nosso futuro deploy usando now.sh. O now é uma plataforma de zeit bem da hora que permite deploy de funções serverless.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fa86cc8aea743cae903d4afb6ecf3c85/77800/telegram-webhook.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.607361963190186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABhUlEQVQY0zVQbSuDURg+XpOQsfZBKUtobL4pyl9QfoekmbGZ9hZtzcuWD8InP4Hy8sUniU9olCjM9jzPeZ6Z9qJkC3O5n2NOXd2dc93Xde7rZrx3BaotSoiBd0eQHttBGUDpVoPSvwp1IApuJX4wBqUzhHz0BPr5KnxAG9kA7yO9zhN0L8aZHZw5CbNQ2BRUc0QIvuMaJDYj3rmoc3SfRM55IPhyoQil0Uua/x5d7wBLtfggGYOQ2gNINnjwMriOs9tL8ONrqNUeyM0+pEzEtwUgkyAzu4/z+ysUlAw04xISPWEkRtfxNByDZPCDJTsWkTKHBJ6NfuSHNmH3u3C6tYtsfQCpZi+SlmVIXSExQdqxhwmvA0/xO7yawni0RvAwvo2EbQVyrUePrI/sqmAaat/qX6SbNEWcoze3iKtSlWk9Wdeh4H/eSlBaaeo6StHkq/Q5wRRqVigar/HQBE5oljX8kKB4IZOB/sk88fPgtQv0gR0595Ew/My+gxuClf2RWRX1kdcvRLZHHQieej0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fluxo telegram\"\n        title=\"Fluxo telegram\"\n        src=\"/static/fa86cc8aea743cae903d4afb6ecf3c85/a6d36/telegram-webhook.png\"\n        srcset=\"/static/fa86cc8aea743cae903d4afb6ecf3c85/222b7/telegram-webhook.png 163w,\n/static/fa86cc8aea743cae903d4afb6ecf3c85/ff46a/telegram-webhook.png 325w,\n/static/fa86cc8aea743cae903d4afb6ecf3c85/a6d36/telegram-webhook.png 650w,\n/static/fa86cc8aea743cae903d4afb6ecf3c85/77800/telegram-webhook.png 855w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Basicamente vamos precisar de uma API, para que o telegram chame a mesma quando algum usuário interagir com nosso BOT.</p>\n<h2>Configurando nossa API para Webhook</h2>\n<p>O primeiro passo é criar uma API simples. Nesse exemplo vou usar express pela popularidade.</p>\n\n        <deckgo-highlight-code language=\"js\"  terminal=\"carbon\" theme=\"material\" line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">// index.js\n\nconst express = require(&#39;express&#39;)\nconst Telegraf = require(&#39;telegraf&#39;)\n\nconst app = express()\n\nconst APP_PORT = 3000\nconst { BOT_TOKEN } = process.env\nconst CURRENT_HOST = &#39;&#39;\n\n// instanciando o bot\nconst bot = new Telegraf(BOT_TOKEN, {\n  telegram: {\n    webhookReply: false\n  }\n})\n\n// configuração de ação tosca no bot\nbot.on(&#39;text&#39;, ctx =&gt; {\n  return ctx.reply(\n    `msg recebida de: ${ctx.message.from.username}`\n  )\n})\n\n// união entre bot e express\napp.use(bot.webhookCallback(&#39;/callback&#39;))\n\napp.get(&#39;/setup&#39;, async (_req, res) =&gt; {\n  const url = `${CURRENT_HOST}/callback`\n  await bot.telegram.setWebhook(url)\n  res.send(`listening on ${CURRENT_HOST}`)\n})\n\napp.listen(APP_PORT, () =&gt; {\n  console.log(`listening on ${APP_PORT}`)\n})</code>\n        </deckgo-highlight-code>\n      \n<p>O esquema é criar uma API simples, com uma rota de /setup inicialmente, que vai ser útil mais tarde. Claro, não esqueça de instalar os módulos (express e telegraf).</p>\n<h3>Explicando por partes:</h3>\n<p>1 — Instanciando nosso bot com o TOKEN que você gerou utilizando o BotFather lá no primeiro passo.</p>\n\n        <deckgo-highlight-code language=\"js\"  terminal=\"carbon\" theme=\"material\" line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">// instanciando o bot\nconst bot = new Telegraf(BOT_TOKEN, {\n  telegram: {\n    webhookReply: false\n  }\n})</code>\n        </deckgo-highlight-code>\n      \n<p>2 — Configuração do o Webhook no telegram.</p>\n\n        <deckgo-highlight-code language=\"js\"  terminal=\"carbon\" theme=\"material\" line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">app.get(&#39;/setup&#39;, async (_req, res) =&gt; {\n  const url = `${CURRENT_HOST}/callback`\n  await bot.telegram.setWebhook(url)\n  res.send(`listening on ${CURRENT_HOST}`)\n})</code>\n        </deckgo-highlight-code>\n      \n<p><em>— Mas Marcos porque você uma rota para isso em vez de fazer na inicialização do código?</em></p>\n<p>Fiz assim para evitar uns pipocos depois de subir no now.sh, foi a melhora forma que encontrei por enquanto.</p>\n<p>Nessa variável <strong>CURRENT_HOST</strong> vamos adicionar posteriormente a URL que o now vai nos fornecer para acesso da nossa API.</p>\n<p>3 — Definição de ação do BOT</p>\n\n        <deckgo-highlight-code language=\"js\"  terminal=\"carbon\" theme=\"material\" line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">// configuração de ação tosca no bot\nbot.on(&#39;text&#39;, ctx =&gt; {\n  return ctx.reply(\n    `msg recebida de: ${ctx.message.from.username}`\n  )\n})</code>\n        </deckgo-highlight-code>\n      \n<p>Uma coisa legal do telegraf é que podemos definir ações com base em eventos, nesse caso um evento de texto digitado pelo usuário. Nesse caso vamos apenas responder que a mensagem foi respondida.</p>\n<p>4 — União entre telefraf e express</p>\n\n        <deckgo-highlight-code language=\"js\"  terminal=\"carbon\" theme=\"material\" line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">app.use(bot.webhookCallback(&#39;/callback&#39;))</code>\n        </deckgo-highlight-code>\n      \n<p>Configuração para a instancia do BOT passar a funcionar e acionar os eventos disponíveis a partir de webhook.</p>\n<h2>Configurando o deploy</h2>\n<p>Man, cria um conta no <a href=\"now.sh\">now.sh</a> depois instala o CLI deles com o npm (npm i -g now).</p>\n<p>No código crie um arquivo chamado now.json na raiz do projeto. Nesse arquivo vamos fazer as configurações necessárias para o deploy da nossa função. Eu estou chamando isso de função pois, apesar de ser uma API no final das contas isso vai virar uma função serveless na estrutura do now, que por fins de curiosidade utiliza o AWS Lambda para funcionar, não me pergunte como esse pessoal ganha dinheiro.</p>\n<p><em>—Pera pera pera, vamos hospedar o bot nesse role de serveless ai e pa, mas quanto vai custar?</em></p>\n<p>Nada, o now tem uns limites bem generosos de funções rodando, desde que seja open source. A partir do momento que você faz um deploy <strong>no modo FREE seu código fica automaticamente exposto na interwebs</strong>, portanto fique <strong>LIGEIRO</strong> com coisas que não devem ser públicas, como o token do bot por exemplo. Utilize variáveis de ambiente. Na verdade, sempre utilize variáveis de ambiente para informações muito sensíveis, me ajude a te ajudar</p>\n<p>A configuração que você precisa montar para o now rodar seu bot é basicamente essa:</p>\n\n        <deckgo-highlight-code language=\"json\"  terminal=\"carbon\" theme=\"material\" line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">{\n  &quot;version&quot;: 2,\n  &quot;alias&quot;: [\n    &quot;nome-do-seu-bot-bosta.now.sh&quot;\n  ],\n  &quot;public&quot;: true,\n  &quot;builds&quot;: [\n    {\n      &quot;src&quot;: &quot;index.js&quot;,\n      &quot;use&quot;: &quot;@now/node-server&quot;\n    }\n  ],\n  &quot;routes&quot;: [\n    {\n      &quot;headers&quot;: {\n        &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;,\n        &quot;Access-Control-Allow-Methods&quot;: &quot;GET, POST, PUT, DELETE, OPTIONS&quot;,\n        &quot;Access-Control-Allow-Headers&quot;: &quot;X-Requested-With, Content-Type, Accept&quot;\n      },\n      &quot;src&quot;: &quot;/.*&quot;,\n      &quot;dest&quot;: &quot;/index.js&quot;\n    }\n  ]\n}</code>\n        </deckgo-highlight-code>\n      \n<p>Você pode copiar essa config e substituir a parte do nome-do-seu-bot-bosta para o nome real do seu BOT já que ele já vai funcionar, deixei alguns outros comentários para explicar o que está rolando na config.</p>\n<p>Lembra a variável CURRENT_HOST? Coloque nela o mesmo conteúdo que colocou no seu ALIAS da configuração do now.sh, mas adicionei um https nesse caso. Ex:</p>\n\n        <deckgo-highlight-code language=\"js\"  terminal=\"carbon\" theme=\"material\" line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">const CURRENT_HOST = “https://nome-do-seu-bot-bosta.now.sh”</code>\n        </deckgo-highlight-code>\n      \n<h3>Lançando o deploy</h3>\n<p>Abre o terminal ou CMD que tu tem ai e roda:</p>\n\n        <deckgo-highlight-code language=\"bash\"  terminal=\"carbon\" theme=\"material\" line-numbers=\"true\" editable=\"true\" >\n          <code slot=\"code\">now -e BOT_TOKEN=token-do-seu-bot  - -prod</code>\n        </deckgo-highlight-code>\n      \n<p>Bem simples né? Como é sua primeira vez (ou não) rodando isso, talvez ele te peça para fazer login e após isso ele vai mostrar informações sobre seu deploy.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 650px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/272f9ee765f1ce7558a0b9a1f8375c6c/b4098/now.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.288343558282207%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsSAAALEgHS3X78AAABF0lEQVQY01WO626DMAyF+yiFFkgISYBwKwGSkACBXqT+mKa9/4vM235Nsqwj+3z2OXHZITmhSfFeIkLPCQ4xCVB6wSTEGehfQSKSoYxdYZ7gvwJ96keljdXGzG7plS4n3cy2UiatWz6MpL0FlJ0pjzNG8zKCW/9gOSi3aruYZVWzHbVZtn1e1mFS7U2KpsUZvYI7RmGCAAhjFERJEKMLwB1YlJlmazfvvNduPZ4v/3iu+2FXP2ijZjdANOfA0PQDpryoGlZWUUpOH1+fclIQ3m77th+LP7b7AzB/fzq/u20H+DaMUmnwFFWdUk54nhD6E/v93ljZdHKEY6LpoLNC0ELkogYBxUVFizLjBStFXtXwFlYwTFn+DWAZS7383FYgAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"deploy usando now\"\n        title=\"deploy usando now\"\n        src=\"/static/272f9ee765f1ce7558a0b9a1f8375c6c/a6d36/now.png\"\n        srcset=\"/static/272f9ee765f1ce7558a0b9a1f8375c6c/222b7/now.png 163w,\n/static/272f9ee765f1ce7558a0b9a1f8375c6c/ff46a/now.png 325w,\n/static/272f9ee765f1ce7558a0b9a1f8375c6c/a6d36/now.png 650w,\n/static/272f9ee765f1ce7558a0b9a1f8375c6c/b4098/now.png 816w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Feito isso precisamos fazer a configuração do webhook no telegram chamando a rota <strong>/setup</strong> da nossa API. Então é so acessar a sua URL configurada na rota de setup.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 539px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bd9c4b0ff3ec065de166e2722981ba38/10f9a/setup.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.12883435582822%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAAA1klEQVQY052MzQ7BQBSF51Fs/CsWEr8tStoITyERtFStRbwYiU6n1rXQ4knamWm4iaQLLMSXk3tPzsm9aKLp+spcmGvNWM2XBkzdMOMZC6qptnhppi/Hk+lmu0PVllQT28pwVBc7DbHblpVOT5VkpdtX5b4KHgzklWozK5RTOSGdL2YKpUQy01MGaH84YEIwxhaG7diEgJyTY2H7aFk2cbBNXPd8vd4834918bzb/Y4opUEQMMYoDTl7A0rKOI+i6PEBhOjxA9E34PdPx1/hnCP2L2EYPgGVvEQCvg8a8wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"get na rota de setup usando o browser\"\n        title=\"get na rota de setup usando o browser\"\n        src=\"/static/bd9c4b0ff3ec065de166e2722981ba38/10f9a/setup.png\"\n        srcset=\"/static/bd9c4b0ff3ec065de166e2722981ba38/222b7/setup.png 163w,\n/static/bd9c4b0ff3ec065de166e2722981ba38/ff46a/setup.png 325w,\n/static/bd9c4b0ff3ec065de166e2722981ba38/10f9a/setup.png 539w\"\n        sizes=\"(max-width: 539px) 100vw, 539px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Se correu tudo bem até aqui seu bot já vai estar respondendo.</p>\n<p>E ai é você e sua criatividade. Veja o que mais o telegraf tem a oferecer para montar seus bots da hora.</p>\n<p>Se tiver algum feedback ou conseguir construir algo legal por favor me chame no <a href=\"https://twitter.com/eptaccio\">twitter</a> ou <a href=\"https://t.me/eptaccio\">telegram</a>.</p>\n<p>Isso é tudo por enquanto, se pá eu volto mostrando como integrar seu BOT em mais plataformas.</p>","frontmatter":{"title":"Criando um bot serverless para telegram","date":"April 06, 2020","description":"Faça seu bot em casa","image":null}}},"pageContext":{"slug":"/telegram-bot/","previous":null,"next":{"fields":{"slug":"/dj-marcinho/"},"frontmatter":{"title":"Como eu construi um BOT para mixagem de aúdios no telegram"}}}}}